---
title: "quick_guide_R"
author: "Jiaojiao He"
date: "2025-07-31"
output: html_document
---
# Introduction
Sometimes a runout issue will happen due to memory limit in R. You can refer to a help file by navigating to "Memory-limits" from base package. ``.Machine$sizeof.pointer`` returns the build version of R: 2 bytes for a 16-bit machine, 4 bytes for a 32-bit machine, and 8 bytes for a 64-bit machine. 

In some cases, you have to increase memory available in R. First, please close other apps. 
- In Window, R function ```memory.limit()``` gives you the amount of available memory. Please increase the "size" argument as much memory as possible under the current window OS and R builds. 
- In macOS, ``Sys.getenv("R_MAX_VSIZE")`` returns the available virtual memory. You can increase using ``Sys.setenv``,e.g., ``Sys.setenv('R_MAX_VSIZE' = "100Gb")``. In fact, macOS already defaults to 64-bit build of R, which allows use of all available RAM.

In R studio, you can see how much memory is being used under "Environment" tab. The recommended minimum RAM in your Machines is 16GB.

# Install msBayesImpute Python and R packages
install python package on terminal, for example:
/Users/jiaojiaohe/.pyenv/shims/pip install "../dist/msbayesimputepy-0.1.0-py3-none-any.whl"
```{r, }
# # specify python environment below or set a default path under Tools/Global Options. 
# # The python environment is consistent with the one downloading the msbayesimputepy python package
# reticulate::use_python('/Users/jiaojiaohe/.pyenv/shims/python')

# install R wrapper package
install.packages("../msBayesImpute_0.1.0.tar.gz", type = "source", repo = NULL)
```

```{r}
library(msBayesImpute)
library(ggplot2)
library(tidyverse)
```

# Generate synthetic data
- The complete data is generated by defining protein size (n_features), sample size (n_samples) and latent factor (n_factors) and protein intercept (alpha_col).
- Missing values are created by a probabilistic dropout distribution characterized by inflection and scale parameters.
```{r}
set.seed(1999)
syn_data <- msBayesImpute::genData(n_features = 5000, n_samples = 50, n_factors = 10, alpha_col = 20)
miss_data <- msBayesImpute::genProbMiss(syn_data$data)
head(miss_data$X_miss)
```

# Or upload external data

## two prerequisites
- data doesn't contain complete missing proteins
- data is normally distribution using like log transformation
```{r}
# read data
X_miss <- read.csv("../data/hela_proteomics_example.csv", row.names = 1) 

# filter completely missing proteins
X_miss <- X_miss[rowSums(!is.na(X_miss)) > 0, ]
```

# Plot missing patterns
```{r}
abundance <- rowMeans(X_miss, na.rm = TRUE)
prob <- rowMeans(is.na(X_miss))
data.frame(abundance = abundance, prob = prob) %>%
  ggplot(aes(x = abundance, y = prob)) +
  geom_point(color = "lightblue") +
        theme_classic() +
        theme(axis.text = element_text(size = 18),
              axis.title = element_text(size = 18, face = "bold"),
              plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
      ggtitle("Missing Pattern")

X_miss %>%
  rownames_to_column("protID") %>%
  pivot_longer(-protID, names_to = "smpID", values_to = "abundance") %>%
  ggplot(aes(x = abundance)) +
  geom_density(fill = "lightgray") +
  theme_classic() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
  labs(title = "Distribution")
```

# Execute msBayesImpute model
- msBayesImpute is user-friendly because it requires no parameter tunning.
- In some cases, users would like to fix the number of latent factors or minimum explained variance, which can be set in msBayesImpute arguments by **n_components** (default is None) and **drop_factor_threshold** (default is 0.01).
- There is also two options in **convergence_mode**: "fast" and "slow" (defualt)

The output "res" contains one imputed data matrix and one msBayesImpute model
```{r}
# 1 run model
res <- runMsBayesImpute(X_miss)

# 2.1 extract imputed data
X_impute <- res$data

# 2.2 extract parameters like weight matrix, factor matrix, dropout charactorized by rho & zeta
pars <- getParams(res$model, X_miss)
```
You can also test the python version
```{python}
from msbayesimputepy.core import msBayesImpute
import pandas as pd

# import data
df = pd.read_csv('../data/hela_proteomics_example.csv', delimiter = ",", index_col = 0)

# perform model
msBayes_model = msBayesImpute()  # arguments
msBayes_model.train(df)

# extract imputed data
impute_data = msBayes_model.predict(df)
```

# Export imputed data
```{r}
write.csv(X_impute, "imputation_R.csv")
```

